概要
>Amazon EC2 F1 は、FPGA (Field Programmable Gate Array) を搭載したコンピューティングインスタンスです。これにより、アプリケーションのためのカスタムハードウェアアクセラレーションをプログラミングで作成できます。F1 インスタンスには、FPGA Developer AMI とハードウェア開発キット (HDK) が含まれていて、ハードウェアアクセラレーションコードの開発、シミュレーション、デバッグ、コンパイルに必要なすべての機能を備えているため、簡単にプログラミングを行うことができます。FPGA の設計が完了すると、それを Amazon FPGA Image (AFI) として登録できるため、数クリックでお使いの F1 インスタンスにデプロイできます。作成した AFI は、必要な F1 インスタンスで何度でも再利用できます。

>Amazon EC2 F1 インスタンスのプレビュー版では、1 つのインスタンスあたり最大 8 個の FPGA を使用できる、2 種類のインスタンスサイズをご利用いただけます。F1 インスタンスには、最新の 16 nm Xilinx UltraScale Plus FPGA が搭載されています。それぞれの FPGA は、ローカルの 64 GiB DDR4 ECC 保護メモリと、専用の PCIe x16 接続を備えています。また、それぞれの FPGA には、約 250 万個の論理素子と、約 6,800 個のデジタルシグナルプロセスエンジンが搭載されています。Amazon EC2 のその他のオンデマンドインスタンスと同じように、前払い料金や長期契約はなく、使用した F1 のコンピューティング性能に対して時間単位の料金が発生します。FPGA Developer AMI や HDK は無料で利用できるので、追加料金なしで、お使いの F1 インスタンスの FPGA を何度でもプログラミングできます。

↓要約すると
- 開発用インスタンス = FPGA Developer AMI + Hardware Developer Kit
- 開発、シミュレーション、デバッグ、コンパイル
- AFI : Amazon FPGA Image
- 16nm Xilinx UltraScale Plus FPGA
  - 64GiB DDR4
  - PCIe x16
- 料金は使用した時間単位
- 開発用のソフトウェアライセンスは無料

![overview](overview.png)
![price](price.png)
Outline

# FPGAとは何か
## CPUとFPGAとGPUの比較
## FPGAのメリット
## F1インスタンスの起動手順
1. FPGA Develoepr AMIを利用して開発用のインスタンスを立てる
  * We recommend that you use C4.4XLarge or bigger, M4.2XLarge or bigger, R4.XLarge or bigger instances for optimal performance.
  * F1インスタンスを指定することも出来たが…オールインワンなインスタンスだと計算資源的にベストではないのかな

2. Hello World 的な
 vivado -mode batch -source /home/centos/src/test/counter/gen_bitstream.tcl

3. GUIデスクトップセッティング
  * AWSではGUIデスクトップを公式にはサポートしていない!
  * このAMIではXRDP and VNCを利用可能
  * SGを編集してRDP用のポートを開ける
  * ユーザアカウント（centos）にパスワードを設定する
  * RDP用のクライアントを用意する
  * aws cliを利用したPythonスクリプトも用意されているが、0.0.0.0/0からのアクセスを許可指定しまうため注意する

4. defaultでgithubのrepositoryのプログラムが入っていないためgit clone する
  * git clone https://github.com/aws/aws-fpga.git $AWS_FPGA_REPO_DIR;
  * cd $AWS_FPGA_REPO_DIR && git pull

5. HDK-setup
  * そのままではライセンスのエラーが出るのでここを参考に
  * ログは別ファイル

6. SDK-setup
  * これをやらないとHDKのmakeが通らない

7. aws configure
  * アクセスキーとリージョンの登録　これをやらないとAWS CLIがうまく動かない？
  * CLI自体はAFIをAWSに登録してF1インスタンスに焼き付ける際に必要だが、開発インスタンスで設計ビルドするまでであれば不要
  ```
  $ export EMAIL=your.email@example.com
  $ ./$HDK_COMMON_DIR/scripts/notify_via_sns.py
  ```
  によってaws_build_dcp_from_cl.shでチェックポイント作成（数時間かかる）が終わったらメールが来るように設定
  ちなみに使い方は
  ```
  aws_build_dcp_from_cl.sh -notify_via_sns
  ```

8. バックアップ保管用のS3バケット作成
```
$ aws s3 mb s3://f1-backup --region us-east-1  # Create an S3 bucket (choose a unique bucket name)
$ aws s3 mb s3://f1-backup/tarfiles   # Create folder for your tarball files
$ aws s3 cp $CL_DIR/build/checkpoints/to_aws/*.Developer_CL.tar \       # Upload the file to S3
         s3://f1-backup/tarfiles/
         ここは*.のところを埋めないとアップロード出来ない場合がある。AWSCLIが貧弱なのか？

$ aws s3 mb s3://f1-backup/logfiles  # Create a folder to keep your logs
$ touch hello_world_log.txt                     # Create a temp file
$ aws s3 cp log.txt s3://f1-backup/logfiles/  #Which creates the folder on S3

```

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Bucket level permissions",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::365015490807:root"
            },
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::f1-backup"
        },
        {
            "Sid": "Object read permissions",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::365015490807:root"
            },
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::f1-backup/tarfiles/17_04_25-032348.Developer_CL.tar"
        },
        {
            "Sid": "Folder write permissions",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::365015490807:root"
            },
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::f1-backup/logfiles/*"
        }
    ]
}
```

check_s3_bucket_policy.py \
--dcp-bucket f1-backup \
--dcp-key tarfiles/17_04_25-032348.Developer_CL.tar \
--logs-bucket f1-backup \
--logs-key logfiles

9. AFI を作る
以下のコマンドを入力
aws ec2 create-fpga-image \
--name test0427 \
--description "This is second test for AFI creation" \
--input-storage-location Bucket=f1-backup,Key=tarfiles/17_04_27-012622.Developer_CL.tar \
--logs-storage-location Bucket=f1-backup,Key=logsfiles/* \
--client-token 20170427 \
--dry-run
[ --dry-run | --no-dry-run ]　これどちらか選ぶらしいけど、どっち選んでもエラー？





# オプションについて
オンデマンド、リザーブド、スポット
AFIがあるのでデプロイは自動化できそうだけど時間がかかるかも



--------
# Idea/懸念事項
- FPGAは高いので教育関係では需要があった
- 一回構築するのに○○分かかるため、すぐにオートスケールは出来ないかも。
- スポットインスタンスは原理的に不可能？スポットとリザーブドインスタンスはいけそうだけど、FPGAをリザーブドにしておくのはAWS的に負担がでかそう。当然ハードは専有される。
- githubは更新が早いため、ドキュメント類は基本的にgithubやforumが参考になる
- AFIをGUIまでセッティングするドキュメント、Vivadoを動かすドキュメント、Helloworldするドキュメント、HDKSDKのセッティングなど資料が分散しすぎ
  - [Github](https://github.com/aws/aws-fpga/blob/master/hdk/cl/examples/README.md):aws-fpgaのリポジトリ
  - [README]():AFIのCentOSのホームフォルダに入ってるmdファイル

- ソフトウェアプログラマーの観点とハードウェアプログラマーの観点の二つを観ないといけない(AWS_Fpga_Pcie_Memory_Map.md)

- 大量のデータを同じ処理の繰り返しで並列に行う場合　→　HAのメリットを最大限に享受できる
  ex ハードウェアスイッチ、

---
# 基本知識
- PCI Express (Peripheral Component Interconnect)：コンピュータのプロセッサと周辺機器との間の通信を行うためのバスアーキテクチャの一つ。

- 論理回路の種類
 - 組み合わせ回路：入力信号によってのみ出力信号が決まるデジタル回路のこと
 - 順序回路：入力信号と順序回路の状態によって出力信号が決まるデジタル回路のこと

- プロセス微細化：CPU の配線の幅（プロセスルール）を小さくすること [link](http://direct.pc-physics.com/column-cpu-refinement.html)
  - 動作周波数の向上：電気抵抗が減るので
  - 低発熱化
  - 省電力化
  - 製造コストの低下
  - 機能強化、多機能化

- [ここ](https://github.com/aws/aws-fpga)を見るとAMIを使わなくてもHDK&SDKは手に入るっぽいがvivado関連のライセンスを取得してないといけないのか？

- on-premiseの環境でも開発は可能だが、ライセンスは自分で用意すること
  >Have an EC2 instance or other server with Xilinx Vivado tools and an active license.

  >One easy way is to have a pre-installed environment is to use the AWS FPGA Developer AMI available on AWS Marketplace which comes with pre-installed Vivado tools and license.

  >For developers who like to work on-premise or different AMI in the cloud, AWS recommend to follow the required license for on-premise document.

- HDKリポジトリにあるドキュメント
  - docs AWSshellとCustom Logicについて
  - common
  - cl custom logicが開発されるフォルダ

- DCP : AWS Shell Design Checkpoint


- 開発インスタンス上では二つのボリュームがある
  - /dev/sda  : OS Xilinx toolsが格納されているボリューム
  - /dev/xvdb : プロジェクトデータが格納されるボリューム　AMIによって最適化されている　home/centos/src/project_data

- cl_hello_worldの構造
  - tie-off のインクルード
  - wires
  - ID Values (cl_hello_world_defines.vh) 何をやっているか謎
  - Resetと同期信号の設定
  - SH to CL のPCIe OCL AXI-Lのアドレス設定
    - write address
    - write data
    - write response
    - read address
    - read data/response
  - PCIe OCL AXI-Lのアドレス設定 slave accessesって書いてあるが内部信号⇄外部信号の接続している？
  - write Request
  - write response
  - read Request
  - read response
  - Hello World Register
  - Virtual LED Register
  - Tie-Off Global Signals ここも謎だけどCL_VERSIONという定数を代入しているだけ？
  - Debug 用の配線
  - VIO Example


- (ビルド手順)[https://github.com/aws/aws-fpga/blob/master/hdk/common/shell_v04151701/new_cl_template/build/README.md]
1. 事前準備
  - HDK_SHELL_DIRの設定　（source hdk_setup.shで自動的に設定される）
  - CL_DIRがCustomLogicがあるルートディレクトリを指しているか確認する。　source prepare_new_clで確認可能
  - vivado入ってる？
2. CLファイルを暗号化する。$CL_DIR/build/scripts/create_dcp_from_cl.tclを少し編集する必要がある
3. CL のビルドの準備　CL_DIR/build/scripts/create_dcp_from_cl.tcl
  - $CL_DIR/build/src_post_encryptionにCL暗号化ファイルが揃っているか？
  - $CL_DIR/build/constraintsのリスト確認
  - その他の制約確認
4. ビルド！
  aws_build_dcp_from_cl.shでビルドする
5. 完成したtarファイルをAWSに提出してAFIを登録する

Starting_Your_Own_CL.md
に沿ってとりあえず準備しょう

axi_register_slice_lightは
common/shell_v04151701/design/ip/axi_register_slice_light/synth
の中で定義されている

synth : synthesis(こっちが本番用)
sim : simulator　（シミュレーション用　timescaleの設定も書いてある）

結論　common/shell_stable の中には共通で使うアーキテクチャの設計ファイルが置かれている。カスタムロジックはここと信号接続をする！　register_sliceが何かはよくわからない


Hello Worldの詳細　パワポにしといて
- Write Request   : awready/wreadyの更新
- Write Response  : bresp = 0 一応アウトプットに繋がっているけど…特に意味はなさそう
- Read Request    : arready の更新
- Read Response   : 主にrdataの更新


---
secret
AKIAI6L7ORYZJ4MHJ3HA
BSjGXdw62s+pdmWbJ4Wo7KEXMqkBcH2aM4G2lFli
---
# Link
- [AWS FPGAデベロッパーフォーラム](https://forums.aws.amazon.com/forum.jspa?forumID=243&start=0)

- [FPGAを搭載した EC2 F1インスタンス – 一般提供開始](https://aws.amazon.com/jp/blogs/news/ec2-f1-instances-with-fpgas-now-generally-available/)

- [開発者プレビュー ー EC2 Instances (F1) with Programmable Hardware](https://aws.amazon.com/jp/blogs/news/developer-preview-ec2-instances-f1-with-programmable-hardware/)

- [Amazon_AWSがFPGA対応してしまった](http://tkysktmt.hatenablog.com/entry/2016/12/03/Amazon_AWS%E3%81%8CFPGA%E5%AF%BE%E5%BF%9C%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%A3%E3%81%9F)
